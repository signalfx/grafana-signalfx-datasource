{"version":3,"sources":["../src/datasource.js"],"names":["_","signalfx","StreamHandler","SignalFxDatasource","instanceSettings","$q","backendSrv","templateSrv","type","url","name","q","withCredentials","authToken","jsonData","accessToken","headers","endpoint","replace","match","p1","p2","console","log","signalflow","window","streamer","SignalFlow","signalflowEndpoint","streams","interpolateQueryStr","bind","options","queries","filter","targets","t","hide","map","program","scopedVars","join","aliases","collectAliases","maxDelay","getMaxDelay","Promise","resolve","data","handler","panelId","start","fromPairs","alias","flatMap","extractLabelsWithAlias","max","re","labels","m","exec","push","doRequest","method","then","response","status","message","title","query","metricNameQuery","getMetrics","propertyKeysQuery","getPropertyKeys","propertyValuesQuery","getPropertyValues","tagsQuery","getTags","when","doQueryRequest","mapMetricsToTextValue","result","results","text","d","value","metric","partialInput","doSuggestQueryRequest","mapPropertiesToTextValue","propertyKey","path","params","escapeQuery","limit","property","programText","packageSpecifications","request","programs","additionalFilters","additionalReplaceOnlyFilters","additionalQuery","JSON","stringify","datasourceRequest","variable","defaultFormatFn","multi","includeAll","escapeLiteral","quoteLiteral","escapedValues","String"],"mappings":"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","file":"datasource.js","sourcesContent":["// Copyright (C) 2019 SignalFx, Inc. All rights reserved.\nimport _ from \"lodash\";\nimport signalfx from './signalfx';\nimport {StreamHandler} from './stream_handler';\n\nexport class SignalFxDatasource {\n\n  constructor(instanceSettings, $q, backendSrv, templateSrv) {\n    this.type = instanceSettings.type;\n    this.url = instanceSettings.url;\n    this.name = instanceSettings.name;\n    this.q = $q;\n    this.backendSrv = backendSrv;\n    this.templateSrv = templateSrv;\n    this.withCredentials = instanceSettings.withCredentials;\n    this.authToken = instanceSettings.jsonData.accessToken;\n    this.headers = {'Content-Type': 'application/json'};\n    this.headers['X-SF-TOKEN'] = this.authToken;\n    this.endpoint = instanceSettings.url.replace(/^(http)(s)?:/, function(match, p1, p2) {\n      return 'ws' + (p2 || '') + ':';\n    });\n    console.log('Using SignalFx at ' + this.endpoint);\n    this.signalflow = window.signalfx.streamer.SignalFlow(this.authToken, {\n      signalflowEndpoint: this.endpoint,\n    });\n    this.streams = [];\n    // give interpolateQueryStr access to this\n    this.interpolateQueryStr = this.interpolateQueryStr.bind(this);\n  }\n\n  query(options) {\n    const queries = _.filter(options.targets, t => {return t.hide !== true;})\n    .map(t => this.templateSrv.replace(t.program, options.scopedVars, this.interpolateQueryStr));\n    var program = queries.join('\\n');\n\n    const aliases = this.collectAliases(options);\n    const maxDelay = this.getMaxDelay(options);\n\n    // TODO: Better validation can be implemented here \n    if (!program) {\n      return Promise.resolve({data: []});\n    }\n\n    var handler = this.streams[options.panelId];\n    if (!handler) {\n      handler = new StreamHandler(this.signalflow, this.templateSrv);\n      this.streams[options.panelId] = handler;\n    }\n    return handler.start(program, aliases, maxDelay, options);\n  }\n\n  collectAliases(options) {\n    return _.fromPairs(_.filter(options.targets, t => {return t.hide !== true && t.program && t.alias;})\n      .map(t => {return {program: this.templateSrv.replace(t.program, options.scopedVars || {}, this.interpolateQueryStr), alias: t.alias};})\n      .flatMap(t => this.extractLabelsWithAlias(t.program, t.alias)));\n  }\n\n  getMaxDelay(options) {\n    var maxDelay = _.max(_.map(options.targets, t => t.maxDelay));\n    if (!maxDelay)\n      maxDelay = 0;\n    return maxDelay;\n  }\n\n  extractLabelsWithAlias(program, alias) {\n    const re = /label\\s?=\\s?'([\\w]*?)'/igm;\n    var labels = [];\n    var m;\n    do {\n        m = re.exec(program);\n        if (m) {\n          labels.push([m[1], alias]);\n        }\n    } while (m);\n    return labels;\n  }\n\n  testDatasource() {\n    return this.doRequest({\n      url: this.url + '/v2/metric',\n      method: 'GET',\n    }).then(response => {\n      if (response.status === 200) {\n        return { status: \"success\", message: \"Data source is working\", title: \"Success\" };\n      }\n    });\n  }\n\n  metricFindQuery(query) {\n    var metricNameQuery = query.match(/^metrics\\(([^\\)]*?)\\)/);\n    if (metricNameQuery) {\n      return this.getMetrics(this.templateSrv.replace(metricNameQuery[1]));\n    }\n    var propertyKeysQuery = query.match(/^property_keys\\(([^\\)]+?)(,\\s?([^,]+?))?\\)/);\n    if (propertyKeysQuery) {\n      return this.getPropertyKeys(this.templateSrv.replace(propertyKeysQuery[1]), this.templateSrv.replace(propertyKeysQuery[3]));\n    }\n    var propertyValuesQuery = query.match(/^property_values\\(([^,]+?),\\s?([^,]+?)(,\\s?(.+))?\\)/);\n    if (propertyValuesQuery) {\n      return this.getPropertyValues(this.templateSrv.replace(propertyValuesQuery[1]), this.templateSrv.replace(propertyValuesQuery[2]), this.templateSrv.replace(propertyValuesQuery[4]));\n    }\n    var tagsQuery = query.match(/^tags\\(([^\\)]+?)(,\\s?([^,]+?))?\\)/);\n    if (tagsQuery) {\n      return this.getTags(this.templateSrv.replace(tagsQuery[1]), this.templateSrv.replace(tagsQuery[3]));\n    }\n    // var globalTagsQuery = query.match(/^tags\\(([^\\)]*?)\\)/);\n    // if (globalTagsQuery) {\n    //   return this.getGlobalTags(this.templateSrv.replace(globalTagsQuery[1]));\n    // }\n    this.q.when([]);\n  }\n\n  getMetrics(query) {\n    return this.doQueryRequest('/v2/metric', 'name:' + (query ? query : '*'))\n      .then(this.mapMetricsToTextValue);\n  }\n\n  mapMetricsToTextValue(result) {\n    return _.map(result.data.results, d => {\n      return { text: d.name, value: d.name };\n    });\n  }\n\n  getPropertyKeys(metric, partialInput) {\n    return this.doSuggestQueryRequest(metric, null, partialInput)\n      .then(this.mapPropertiesToTextValue);\n  }\n\n  getPropertyValues(metric, propertyKey, partialInput) {\n    return this.doSuggestQueryRequest(metric, propertyKey, partialInput)\n      .then(this.mapPropertiesToTextValue);\n  }\n\n  getTags(metric, partialInput) {\n    return this.doSuggestQueryRequest(metric, 'sf_tags', partialInput)\n      .then(this.mapPropertiesToTextValue);\n  }\n\n  mapPropertiesToTextValue(result) {\n    return _.map(result.data, d => {\n      return { text: d, value: d };\n    });\n  }\n\n  // getGlobalTags(query) {\n  //   return this.doQueryRequest('/v2/tag', query)\n  //     .then(this.mapMetricsToTextValue);\n  // }\n\n  doQueryRequest(path, query) {\n    return this.doRequest({\n      url: this.url + path,\n      params: {query: this.escapeQuery(query), limit: 100},\n      method: 'GET',\n    });\n  }\n\n  doSuggestQueryRequest(metric, property, partialInput) {\n    var program = {\n      programText: 'data(\\'' + metric +'\\').publish(label=\\'A\\')',\n      packageSpecifications: ''\n    };\n    var request = {\n      programs: [program],\n      property,\n      partialInput: partialInput != null ? partialInput : '',\n      limit: 100,\n      additionalFilters: [],\n      additionalReplaceOnlyFilters:[],\n      additionalQuery: null\n    };\n    return this.doRequest({\n      url: this.url + '/v2/suggest/_signalflowsuggest',\n      data: JSON.stringify(request),\n      method: 'POST'\n    });\n  }\n\n  escapeQuery(query) {\n    return query.replace(/[\\/]/g, '\\\\$&');\n  }\n\n  doRequest(options) {\n    options.headers = this.headers;\n    return this.backendSrv.datasourceRequest(options);\n  }\n\n  interpolateQueryStr(value, variable, defaultFormatFn) {\n    // if no multi or include all do not regexEscape\n    if (!variable.multi && !variable.includeAll) {\n      return this.escapeLiteral(value);\n    }\n\n    if (typeof value === 'string') {\n      return this.quoteLiteral(value);\n    }\n\n    const escapedValues = _.map(value, this.quoteLiteral);\n    return escapedValues.join(',');\n  }\n\n  quoteLiteral(value) {\n    return \"'\" + String(value).replace(/'/g, \"''\") + \"'\";\n  }\n\n  escapeLiteral(value) {\n    return String(value).replace(/'/g, \"''\");\n  }\n\n}\n"]}