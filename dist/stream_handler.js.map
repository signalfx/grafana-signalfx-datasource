{"version":3,"sources":["../src/stream_handler.js"],"names":["defer","res","rej","promise","Promise","resolve","reject","_","moment","MAX_DATAPOINTS_TO_KEEP_BEFORE_TIMERANGE","INACTIVE_JOB_MINUTES","STREAMING_THRESHOLD_MINUTES","StreamHandler","signalflow","templateSrv","program","aliases","maxDelay","options","isJobReusable","unboundedBatchPhase","initializeTimeRange","flushData","stop","execute","setupCleanupTask","desiredMaxDelay","intervalMs","startTime","range","from","valueOf","unbounded","running","stopTime","to","jobStartTimeout","clearTimeout","setTimeout","console","debug","handle","close","log","initialize","params","start","resolution","stream","handleData","bind","metrics","maxDataPoints","resolutionMs","Date","now","cutoffTime","Math","min","err","data","message","type","messageCode","contents","maxDelayMs","event","appendData","batchPhaseFlushTimeout","i","length","point","datapoints","tsId","push","value","logicalTimestampMs","nextEstimatedTimestamp","ceil","floor","seriesList","minTime","maxTime","timeRangeStart","shift","tsName","getTimeSeriesName","target","name","id","slice","sort","a","b","localeCompare","obj","get_metadata","candidates","excludedDimensions","tsVars","result","c","properties","toLowerCase","startsWith","text","key","k","dimension","indexOf","join","repr","alias","find","replace"],"mappings":";;;;;;;;;;;;;AAIA,WAASA,KAAT,GAAiB;AACf,QAAIC,GAAJ,EAASC,GAAT;;AAEA,QAAIC,UAAU,IAAIC,OAAJ,CAAY,UAACC,OAAD,EAAUC,MAAV,EAAqB;AAC7CL,YAAMI,OAAN;AACAH,YAAMI,MAAN;AACD,KAHa,CAAd;;AAKAH,YAAQE,OAAR,GAAkBJ,GAAlB;AACAE,YAAQG,MAAR,GAAiBJ,GAAjB;;AAEA,WAAOC,OAAP;AACD;;;;AAfMI,O;;AACAC,Y;;;;;;;;;;;;;;;;;;;;;AAgBDC,6C,GAA0C,C;AAC1CC,0B,GAAuB,C;AACvBC,iC,GAA8B,C;;+BAEvBC,a;AAEX,+BAAYC,UAAZ,EAAwBC,WAAxB,EAAqC;AAAA;;AACnC,eAAKD,UAAL,GAAkBA,UAAlB;AACA,eAAKC,WAAL,GAAmBA,WAAnB;AACD;;;;gCAEKC,O,EAASC,O,EAASC,Q,EAAUC,O,EAAS;AACzC,iBAAKF,OAAL,GAAeA,OAAf;AACA,gBAAI,KAAKG,aAAL,CAAmBJ,OAAnB,EAA4BE,QAA5B,EAAsCC,OAAtC,CAAJ,EAAoD;AAClD,kBAAI,CAAC,KAAKE,mBAAV,EAA+B;AAC7B,qBAAKjB,OAAL,GAAeH,OAAf;AACA,qBAAKqB,mBAAL,CAAyBH,OAAzB;AACA,qBAAKI,SAAL;AACD;AACF,aAND,MAMO;AACL,mBAAKnB,OAAL,GAAeH,OAAf;AACA,mBAAKuB,IAAL;AACA,mBAAKC,OAAL,CAAaT,OAAb,EAAsBE,QAAtB,EAAgCC,OAAhC;AACD;AACD,iBAAKO,gBAAL;AACA,mBAAO,KAAKtB,OAAZ;AACD;;;wCAEaY,O,EAASE,Q,EAAUC,O,EAAS;AACxC,mBAAO,KAAKH,OAAL,IAAgBA,OAAhB,IACF,KAAKW,eAAL,IAAwBT,QADtB,IAEF,KAAKU,UAAL,IAAmBT,QAAQS,UAFzB,IAGF,KAAKC,SAAL,IAAkBV,QAAQW,KAAR,CAAcC,IAAd,CAAmBC,OAAnB,EAHhB,KAIA,KAAKC,SAAL,IAAkB,KAAKC,OAAxB,IAAoC,KAAKC,QAAL,IAAiBhB,QAAQW,KAAR,CAAcM,EAAd,CAAiBJ,OAAjB,EAJpD,CAAP;AAKD;;;6CAEkB;AAAA;;AACjB,gBAAI,KAAKK,eAAT,EAA0B;AACxBC,2BAAa,KAAKD,eAAlB;AACD;AACD,iBAAKA,eAAL,GAAuBE,WAAW,YAAM;AACtCC,sBAAQC,KAAR,CAAc,sBAAsB9B,oBAAtB,GAA6C,YAA7C,GAA4D,MAAKK,OAA/E;AACA,oBAAKQ,IAAL;AACD,aAHsB,EAGpBb,uBAAuB,EAAvB,GAA4B,IAHR,CAAvB;AAID;;;iCAEM;AACL,gBAAI,KAAKuB,OAAT,EAAkB;AAChBM,sBAAQC,KAAR,CAAc,kCAAd;AACA,mBAAKC,MAAL,CAAYC,KAAZ;AACA,mBAAKT,OAAL,GAAe,KAAf;AACD;AACF;;;kCAEOlB,O,EAASE,Q,EAAUC,O,EAAS;AAClCqB,oBAAQI,GAAR,CAAY,sCAAsC5B,OAAlD;AACA,iBAAK6B,UAAL,CAAgB7B,OAAhB,EAAyBE,QAAzB,EAAmCC,OAAnC;AACA,gBAAI2B,SAAS;AACX9B,uBAAS,KAAKA,OADH;AAEX+B,qBAAO,KAAKlB,SAFD;AAGXmB,0BAAY,KAAKpB;AAHN,aAAb;AAKA,gBAAI,CAAC,KAAKK,SAAV,EAAqB;AACnBa,qBAAO,MAAP,IAAiB,KAAKX,QAAtB;AACAW,qBAAO,WAAP,IAAsB,IAAtB;AACD;AACD,gBAAI,KAAK5B,QAAT,EAAmB;AACjB4B,qBAAO,UAAP,IAAqB,KAAK5B,QAA1B;AACD;AACD,iBAAKwB,MAAL,GAAc,KAAK5B,UAAL,CAAgBW,OAAhB,CAAwBqB,MAAxB,CAAd;AACA,iBAAKZ,OAAL,GAAe,IAAf;AACA,iBAAKQ,MAAL,CAAYO,MAAZ,CAAmB,KAAKC,UAAL,CAAgBC,IAAhB,CAAqB,IAArB,CAAnB;AACD;;;qCAEUnC,O,EAASE,Q,EAAUC,O,EAAS;AACrC,iBAAKiC,OAAL,GAAe,EAAf;AACA,iBAAKpC,OAAL,GAAeA,OAAf;AACA,iBAAKE,QAAL,GAAgBA,QAAhB;AACA,iBAAKS,eAAL,GAAuBT,QAAvB;AACA,iBAAKI,mBAAL,CAAyBH,OAAzB;AACA,iBAAKS,UAAL,GAAkBT,QAAQS,UAA1B;AACA,iBAAKyB,aAAL,GAAqBlC,QAAQkC,aAA7B;AACA,iBAAKC,YAAL,GAAoBnC,QAAQS,UAA5B;AACA,iBAAKK,SAAL,GAAiB,KAAKE,QAAL,GAAgBoB,KAAKC,GAAL,KAAa5C,8BAA8B,EAA9B,GAAmC,IAAjF;AACA,iBAAKS,mBAAL,GAA2B,KAAKY,SAAhC;AACD;;;8CAEmBd,O,EAAS;AAC3B,iBAAKU,SAAL,GAAiBV,QAAQW,KAAR,CAAcC,IAAd,CAAmBC,OAAnB,EAAjB;AACA,iBAAKG,QAAL,GAAgBhB,QAAQW,KAAR,CAAcM,EAAd,CAAiBJ,OAAjB,EAAhB;AACA,iBAAKyB,UAAL,GAAkBC,KAAKC,GAAL,CAASJ,KAAKC,GAAL,EAAT,EAAqB,KAAKrB,QAA1B,CAAlB;AACD;;;qCAEUyB,G,EAAKC,I,EAAM;AAAA;;AACpB,gBAAID,GAAJ,EAAS;AACPpB,sBAAQC,KAAR,CAAc,cAAd,EAA8BmB,GAA9B;AACA,mBAAKpC,IAAL;AACA,mBAAKpB,OAAL,CAAaG,MAAb,CAAoBqD,IAAIE,OAAxB;AACA;AACD;;AAED,gBAAID,KAAKE,IAAL,KAAc,SAAd,IAA2BF,KAAKC,OAAL,CAAaE,WAAb,KAA6B,wBAA5D,EAAsF;AACpF,mBAAKV,YAAL,GAAoBO,KAAKC,OAAL,CAAaG,QAAb,CAAsBX,YAA1C;AACD;;AAED,gBAAIO,KAAKE,IAAL,KAAc,SAAd,IAA2BF,KAAKC,OAAL,CAAaE,WAAb,KAA6B,uBAA5D,EAAqF;AACnF,mBAAK9C,QAAL,GAAgB2C,KAAKC,OAAL,CAAaG,QAAb,CAAsBC,UAAtC;AACD;;AAED,gBAAIL,KAAKE,IAAL,KAAc,iBAAd,KAAoCF,KAAKM,KAAL,KAAe,gBAAf,IAAmCN,KAAKM,KAAL,KAAe,eAAtF,CAAJ,EAA4G;AAC1G,mBAAK5C,SAAL;AACA,mBAAKC,IAAL;AACD;;AAED,gBAAIqC,KAAKE,IAAL,KAAc,MAAlB,EAA0B;AACxBvB,sBAAQC,KAAR,CAAcoB,IAAd;AACA;AACD;;AAED,gBAAI,KAAKO,UAAL,CAAgBP,IAAhB,KAAyB,KAAKxC,mBAAlC,EAAuD;AACrD;AACA,kBAAI,KAAKgD,sBAAT,EAAiC;AAC/B/B,6BAAa,KAAK+B,sBAAlB;AACD;AACD,mBAAKA,sBAAL,GAA8B9B,WAAW;AAAA,uBAAM,OAAKhB,SAAL,EAAN;AAAA,eAAX,EAAmC,GAAnC,CAA9B;AACD;AACF;;;qCAEUsC,I,EAAM;AACf,iBAAK,IAAIS,IAAI,CAAb,EAAgBA,IAAIT,KAAKA,IAAL,CAAUU,MAA9B,EAAsCD,GAAtC,EAA2C;AACzC,kBAAIE,QAAQX,KAAKA,IAAL,CAAUS,CAAV,CAAZ;AACA,kBAAIG,aAAa,KAAKrB,OAAL,CAAaoB,MAAME,IAAnB,CAAjB;AACA,kBAAI,CAACD,UAAL,EAAiB;AACfA,6BAAa,EAAb;AACA,qBAAKrB,OAAL,CAAaoB,MAAME,IAAnB,IAA2BD,UAA3B;AACD;AACDA,yBAAWE,IAAX,CAAgB,CAACH,MAAMI,KAAP,EAAcf,KAAKgB,kBAAnB,CAAhB;AACD;AACD;AACA,gBAAIC,yBAAyBjB,KAAKgB,kBAAL,GAA0BnB,KAAKqB,IAAL,CAAU,KAAK7D,QAAL,GAAgB,KAAKoC,YAArB,GAAoC,CAA9C,IAAmD,KAAKA,YAA/G;AACA,mBAAOwB,yBAAyBpB,KAAKsB,KAAL,CAAW,KAAKvB,UAAL,GAAkB,KAAKH,YAAlC,IAAkD,KAAKA,YAAvF;AACD;;;sCAEW;AACV,iBAAKjC,mBAAL,GAA2B,KAA3B;AACA,gBAAI4D,aAAa,EAAjB;AACA,gBAAIC,UAAU,CAAd;AACA,gBAAIC,UAAU,CAAd;AACA,gBAAIC,iBAAiB,KAAKvD,SAAL,GAAiBnB,0CAA0C,KAAK4C,YAArF;AACA,iBAAK,IAAIoB,IAAT,IAAiB,KAAKtB,OAAtB,EAA+B;AAC7B,kBAAIqB,aAAa,KAAKrB,OAAL,CAAasB,IAAb,CAAjB;AACA,qBAAOD,WAAWF,MAAX,GAAoB,CAApB,IAAyBa,iBAAiBX,WAAW,CAAX,EAAc,CAAd,CAAjD,EAAmE;AACjEA,2BAAWY,KAAX;AACD;AACD,kBAAIZ,WAAWF,MAAX,GAAoB,CAAxB,EAA2B;AACzB,oBAAIW,WAAW,CAAX,IAAgBA,UAAUT,WAAW,CAAX,EAAc,CAAd,CAA9B,EAAgD;AAC9CS,4BAAUT,WAAW,CAAX,EAAc,CAAd,CAAV;AACD;AACD,oBAAIU,WAAW,CAAX,IAAgBA,UAAUV,WAAWA,WAAWF,MAAX,GAAoB,CAA/B,EAAkC,CAAlC,CAA9B,EAAoE;AAClEY,4BAAUV,WAAWA,WAAWF,MAAX,GAAoB,CAA/B,EAAkC,CAAlC,CAAV;AACD;AACF;AACD,kBAAIe,SAAS,KAAKC,iBAAL,CAAuBb,IAAvB,CAAb;AACAO,yBAAWN,IAAX,CAAgB,EAAEa,QAAQF,OAAOG,IAAjB,EAAuBC,IAAIJ,OAAOI,EAAlC,EAAsCjB,YAAYA,WAAWkB,KAAX,EAAlD,EAAhB;AACD;AACD;AACAV,uBAAWW,IAAX,CAAgB,UAACC,CAAD,EAAIC,CAAJ;AAAA,qBAAUD,EAAEH,EAAF,CAAKK,aAAL,CAAmBD,EAAEJ,EAArB,CAAV;AAAA,aAAhB;AACA,gBAAI7B,OAAO;AACTA,oBAAMoB,UADG;AAETnD,qBAAO,EAAEC,MAAMtB,OAAOyE,OAAP,CAAR,EAAyB9C,IAAI3B,OAAO0E,OAAP,CAA7B;AAFE,aAAX;AAIA,iBAAK/E,OAAL,CAAaE,OAAb,CAAqBuD,IAArB;AACArB,oBAAQC,KAAR,CAAc,oBAAoB,KAAKzB,OAAvC;AACD;;;4CAEiB0D,I,EAAM;AACtB,gBAAIsB,MAAM,KAAKtD,MAAL,CAAYuD,YAAZ,CAAyBvB,IAAzB,CAAV;AACA,gBAAI,CAACsB,GAAL,EAAU;AACR,qBAAO,EAAEN,IAAIhB,IAAN,EAAYe,MAAMf,IAAlB,EAAP;AACD;;AAED,gBAAIwB,aAAa,CAAC,WAAD,EAAc,sBAAd,CAAjB;AACA,gBAAIC,qBAAqB,CAAC,WAAD,EAAc,sBAAd,EAAsC,OAAtC,EAA+C,WAA/C,EAA4D,eAA5D,CAAzB;;AAEA,gBAAIC,SAAS,EAAb;AACA,gBAAIC,SAAS,EAAb;AACA,iBAAK,IAAIC,CAAT,IAAcJ,UAAd,EAA0B;AACxB,kBAAItB,QAAQoB,IAAIO,UAAJ,CAAeL,WAAWI,CAAX,CAAf,CAAZ;AACA,kBAAI1B,SAAS,CAACA,MAAM4B,WAAN,GAAoBC,UAApB,CAA+B,MAA/B,CAAd,EAAsD;AACpDL,uBAAO,QAAP,IAAmB,EAAEM,MAAM9B,KAAR,EAAeA,OAAOA,KAAtB,EAAnB;AACAyB,uBAAO1B,IAAP,CAAYC,KAAZ;AACD;AACF;;AAED,gBAAI+B,MAAM,EAAV;AACA,iBAAK,IAAIC,CAAT,IAAcZ,IAAIO,UAAJ,CAAe,QAAf,CAAd,EAAwC;AACtC,kBAAIM,YAAYb,IAAIO,UAAJ,CAAe,QAAf,EAAyBK,CAAzB,CAAhB;AACA,kBAAIT,mBAAmBW,OAAnB,CAA2BD,SAA3B,MAA0C,CAAC,CAA/C,EAAkD;AAChD,oBAAIjC,QAAQoB,IAAIO,UAAJ,CAAeM,SAAf,CAAZ;AACA,oBAAIjC,KAAJ,EAAW;AACT+B,sBAAIhC,IAAJ,CAASkC,YAAY,GAAZ,GAAkBjC,KAA3B;AACAwB,yBAAOS,SAAP,IAAoB,EAAEH,MAAM9B,KAAR,EAAeA,OAAOA,KAAtB,EAApB;AACD;AACF;AACF;;AAEDyB,mBAAO1B,IAAP,CAAYgC,IAAII,IAAJ,CAAS,GAAT,CAAZ;;AAEA,gBAAIC,OAAO,EAAX;AACA,gBAAIC,QAAQ,IAAZ;AACA,gBAAIjB,IAAIO,UAAJ,CAAe,gBAAf,CAAJ,EAAsC;AACpCH,qBAAO,OAAP,IAAkB,EAAEM,MAAMV,IAAIO,UAAJ,CAAe,gBAAf,CAAR,EAA0C3B,OAAOoB,IAAIO,UAAJ,CAAe,gBAAf,CAAjD,EAAlB;AACAS,sBAAQhB,IAAIO,UAAJ,CAAe,gBAAf,IAAmC,GAA3C;AACAU,sBAAQ,KAAKhG,OAAL,CAAa+E,IAAIO,UAAJ,CAAe,gBAAf,CAAb,CAAR;AACD,aAJD,MAIO;AACLU,sBAAQzG,EAAE0G,IAAF,CAAO,KAAKjG,OAAZ,EAAqB;AAAA,uBAAK,IAAL;AAAA,eAArB,CAAR;AACD;AACD,gBAAIyE,KAAKsB,OAAOX,OAAOU,IAAP,CAAY,GAAZ,CAAhB;AACA,gBAAItB,OAAOwB,QAAQ,KAAKlG,WAAL,CAAiBoG,OAAjB,CAAyBF,KAAzB,EAAgCb,MAAhC,CAAR,GAAkDV,EAA7D;AACA,mBAAO,EAAEA,MAAF,EAAMD,UAAN,EAAP;AACD","file":"stream_handler.js","sourcesContent":["// Copyright (C) 2019 SignalFx, Inc. All rights reserved.\nimport _ from \"lodash\";\nimport moment from 'moment';\n\nfunction defer() {\n  var res, rej;\n\n  var promise = new Promise((resolve, reject) => {\n    res = resolve;\n    rej = reject;\n  });\n\n  promise.resolve = res;\n  promise.reject = rej;\n\n  return promise;\n}\n\nconst MAX_DATAPOINTS_TO_KEEP_BEFORE_TIMERANGE = 1;\nconst INACTIVE_JOB_MINUTES = 6;\nconst STREAMING_THRESHOLD_MINUTES = 2;\n\nexport class StreamHandler {\n\n  constructor(signalflow, templateSrv) {\n    this.signalflow = signalflow;\n    this.templateSrv = templateSrv;\n  }\n\n  start(program, aliases, maxDelay, options) {\n    this.aliases = aliases;\n    if (this.isJobReusable(program, maxDelay, options)) {\n      if (!this.unboundedBatchPhase) {\n        this.promise = defer();\n        this.initializeTimeRange(options);\n        this.flushData();\n      }\n    } else {\n      this.promise = defer();\n      this.stop();\n      this.execute(program, maxDelay, options);\n    }\n    this.setupCleanupTask();\n    return this.promise;\n  }\n\n  isJobReusable(program, maxDelay, options) {\n    return this.program == program\n      && this.desiredMaxDelay == maxDelay\n      && this.intervalMs == options.intervalMs\n      && this.startTime <= options.range.from.valueOf()\n      && ((this.unbounded && this.running) || this.stopTime >= options.range.to.valueOf());\n  }\n\n  setupCleanupTask() {\n    if (this.jobStartTimeout) {\n      clearTimeout(this.jobStartTimeout);\n    }\n    this.jobStartTimeout = setTimeout(() => {\n      console.debug('Job inactive for ' + INACTIVE_JOB_MINUTES + ' minutes: ' + this.program);\n      this.stop();\n    }, INACTIVE_JOB_MINUTES * 60 * 1000);\n  }\n\n  stop() {\n    if (this.running) {\n      console.debug('Stopping SignalFlow computation.');\n      this.handle.close();\n      this.running = false;\n    }\n  }\n\n  execute(program, maxDelay, options) {\n    console.log('Starting SignalFlow computation: ' + program);\n    this.initialize(program, maxDelay, options);\n    var params = {\n      program: this.program,\n      start: this.startTime,\n      resolution: this.intervalMs,\n    };\n    if (!this.unbounded) {\n      params['stop'] = this.stopTime;\n      params['immediate'] = true;\n    }\n    if (this.maxDelay) {\n      params['maxDelay'] = this.maxDelay;\n    }\n    this.handle = this.signalflow.execute(params);\n    this.running = true;\n    this.handle.stream(this.handleData.bind(this));\n  }\n\n  initialize(program, maxDelay, options) {\n    this.metrics = {};\n    this.program = program;\n    this.maxDelay = maxDelay;\n    this.desiredMaxDelay = maxDelay;\n    this.initializeTimeRange(options);\n    this.intervalMs = options.intervalMs;\n    this.maxDataPoints = options.maxDataPoints;\n    this.resolutionMs = options.intervalMs;\n    this.unbounded = this.stopTime > Date.now() - STREAMING_THRESHOLD_MINUTES * 60 * 1000;\n    this.unboundedBatchPhase = this.unbounded;\n  }\n\n  initializeTimeRange(options) {\n    this.startTime = options.range.from.valueOf();\n    this.stopTime = options.range.to.valueOf();\n    this.cutoffTime = Math.min(Date.now(), this.stopTime);\n  }\n\n  handleData(err, data) {\n    if (err) {\n      console.debug('Stream error', err);\n      this.stop();\n      this.promise.reject(err.message);\n      return;\n    }\n\n    if (data.type === 'message' && data.message.messageCode === 'JOB_RUNNING_RESOLUTION') {\n      this.resolutionMs = data.message.contents.resolutionMs;\n    }\n\n    if (data.type === 'message' && data.message.messageCode === 'JOB_INITIAL_MAX_DELAY') {\n      this.maxDelay = data.message.contents.maxDelayMs;\n    }\n\n    if (data.type === 'control-message' && (data.event === 'END_OF_CHANNEL' || data.event === 'CHANNEL_ABORT')) {\n      this.flushData();\n      this.stop();\n    }\n\n    if (data.type !== 'data') {\n      console.debug(data);\n      return;\n    }\n\n    if (this.appendData(data) && this.unboundedBatchPhase) {\n      // Do not flush immediately as some more data may be still received\n      if (this.batchPhaseFlushTimeout) {\n        clearTimeout(this.batchPhaseFlushTimeout);\n      }\n      this.batchPhaseFlushTimeout = setTimeout(() => this.flushData(), 500);\n    }\n  }\n\n  appendData(data) {\n    for (var i = 0; i < data.data.length; i++) {\n      var point = data.data[i];\n      var datapoints = this.metrics[point.tsId];\n      if (!datapoints) {\n        datapoints = [];\n        this.metrics[point.tsId] = datapoints;\n      }\n      datapoints.push([point.value, data.logicalTimestampMs]);\n    }\n    // Estimate an align timestamps to boundaries based on resolution\n    var nextEstimatedTimestamp = data.logicalTimestampMs + Math.ceil(this.maxDelay / this.resolutionMs + 1) * this.resolutionMs;\n    return nextEstimatedTimestamp > Math.floor(this.cutoffTime / this.resolutionMs) * this.resolutionMs;\n  }\n\n  flushData() {\n    this.unboundedBatchPhase = false;\n    var seriesList = [];\n    var minTime = 0;\n    var maxTime = 0;\n    var timeRangeStart = this.startTime - MAX_DATAPOINTS_TO_KEEP_BEFORE_TIMERANGE * this.resolutionMs;\n    for (var tsId in this.metrics) {\n      var datapoints = this.metrics[tsId];\n      while (datapoints.length > 0 && timeRangeStart > datapoints[0][1]) {\n        datapoints.shift();\n      }\n      if (datapoints.length > 0) {\n        if (minTime == 0 || minTime > datapoints[0][1]) {\n          minTime = datapoints[0][1];\n        }\n        if (maxTime == 0 || maxTime < datapoints[datapoints.length - 1][1]) {\n          maxTime = datapoints[datapoints.length - 1][1];\n        }\n      }\n      var tsName = this.getTimeSeriesName(tsId);\n      seriesList.push({ target: tsName.name, id: tsName.id, datapoints: datapoints.slice() });\n    }\n    // Ensure consistent TS order\n    seriesList.sort((a, b) => a.id.localeCompare(b.id));\n    var data = {\n      data: seriesList,\n      range: { from: moment(minTime), to: moment(maxTime) },\n    };\n    this.promise.resolve(data);\n    console.debug('Data returned: ' + this.program);\n  }\n\n  getTimeSeriesName(tsId) {\n    var obj = this.handle.get_metadata(tsId);\n    if (!obj) {\n      return { id: tsId, name: tsId };\n    }\n\n    var candidates = ['sf_metric', 'sf_originatingMetric'];\n    var excludedDimensions = ['sf_metric', 'sf_originatingMetric', 'jobId', 'programId', 'computationId'];\n\n    var tsVars = {};\n    var result = [];\n    for (var c in candidates) {\n      var value = obj.properties[candidates[c]];\n      if (value && !value.toLowerCase().startsWith('_sf_')) {\n        tsVars['metric'] = { text: value, value: value };\n        result.push(value);\n      }\n    }\n\n    var key = [];\n    for (var k in obj.properties['sf_key']) {\n      var dimension = obj.properties['sf_key'][k];\n      if (excludedDimensions.indexOf(dimension) === -1) {\n        var value = obj.properties[dimension];\n        if (value) {\n          key.push(dimension + '=' + value);\n          tsVars[dimension] = { text: value, value: value };\n        }\n      }\n    }\n\n    result.push(key.join(','));\n\n    var repr = '';\n    var alias = null;\n    if (obj.properties['sf_streamLabel']) {\n      tsVars['label'] = { text: obj.properties['sf_streamLabel'], value: obj.properties['sf_streamLabel'] };\n      repr += obj.properties['sf_streamLabel'] + ':';\n      alias = this.aliases[obj.properties['sf_streamLabel']];\n    } else {\n      alias = _.find(this.aliases, a => true);\n    }\n    var id = repr + result.join('/');\n    var name = alias ? this.templateSrv.replace(alias, tsVars) : id;\n    return { id, name };\n  }\n}\n"]}