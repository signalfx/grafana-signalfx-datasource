{"version":3,"sources":["../src/stream_handler.js"],"names":["defer","res","rej","promise","Promise","resolve","reject","moment","StreamHandler","signalflow","program","aliases","options","templateSrv","handle","metrics","console","log","execute","start","range","from","valueOf","resolution","resolutionMs","stop","to","immediate","stream","handleData","bind","err","data","onError","message","type","messageCode","contents","debug","maxDataPoints","event","streamStartTimeout","setTimeout","warn","clearTimeout","flushData","onCompleted","appendData","i","length","point","series","tsId","tsName","getTimeSeriesName","target","name","id","datapoints","push","value","logicalTimestampMs","shift","obj","get_metadata","candidates","excludedDimensions","tsVars","result","c","properties","toLowerCase","startsWith","text","key","k","dimension","indexOf","join","repr","alias","_","find","replace","seriesList","sort","a","b","localeCompare","end","error","close"],"mappings":";;;;;;;;;;;;;AAGA,WAASA,KAAT,GAAiB;AACf,QAAIC,GAAJ,EAASC,GAAT;;AAEA,QAAIC,UAAU,IAAIC,OAAJ,CAAY,UAACC,OAAD,EAAUC,MAAV,EAAqB;AAC7CL,YAAMI,OAAN;AACAH,YAAMI,MAAN;AACD,KAHa,CAAd;;AAKAH,YAAQE,OAAR,GAAkBJ,GAAlB;AACAE,YAAQG,MAAR,GAAiBJ,GAAjB;;AAEA,WAAOC,OAAP;AACD;;;;AAdMI,Y;;;;;;;;;;;;;;;;;;;;;+BAgBMC,a;AAEX,+BAAYC,UAAZ,EAAwBC,OAAxB,EAAiCC,OAAjC,EAA0CC,OAA1C,EAAmDC,WAAnD,EAAgE;AAAA;;AAC9D,eAAKJ,UAAL,GAAkBA,UAAlB;AACA,eAAKC,OAAL,GAAeA,OAAf;AACA,eAAKC,OAAL,GAAeA,OAAf;AACA,eAAKC,OAAL,GAAeA,OAAf;AACA,eAAKC,WAAL,GAAmBA,WAAnB;AACA,eAAKC,MAAL,GAAc,IAAd;AACA,eAAKX,OAAL,GAAeH,OAAf;AACD;;;;kCAEO;AACN,iBAAKe,OAAL,GAAe,EAAf;AACAC,oBAAQC,GAAR,CAAY,sCAAsC,KAAKP,OAAvD;AACA,iBAAKI,MAAL,GAAc,KAAKL,UAAL,CAAgBS,OAAhB,CAAwB;AACpCR,uBAAS,KAAKA,OADsB;AAEpCS,qBAAO,KAAKP,OAAL,CAAaQ,KAAb,CAAmBC,IAAnB,CAAwBC,OAAxB,EAF6B;AAGpCC,0BAAY,KAAKX,OAAL,CAAaY,YAHW;AAIpCC,oBAAM,KAAKb,OAAL,CAAaQ,KAAb,CAAmBM,EAAnB,CAAsBJ,OAAtB,EAJ8B;AAKpCK,yBAAW;AALyB,aAAxB,CAAd;AAOA,iBAAKb,MAAL,CAAYc,MAAZ,CAAmB,KAAKC,UAAL,CAAgBC,IAAhB,CAAqB,IAArB,CAAnB;AACA,mBAAO,KAAK3B,OAAZ;AACD;;;qCAGU4B,G,EAAKC,I,EAAM;;AAEpB,gBAAID,GAAJ,EAAS;AACP,mBAAKE,OAAL,CAAaF,IAAIG,OAAjB;AACA;AACD;;AAED,gBAAIF,KAAKG,IAAL,KAAc,SAAd,IAA2BH,KAAKE,OAAL,CAAaE,WAAb,KAA6B,wBAA5D,EAAsF;AACpF,mBAAKxB,OAAL,CAAaY,YAAb,GAA4BQ,KAAKE,OAAL,CAAaG,QAAb,CAAsBb,YAAlD;AACAR,sBAAQsB,KAAR,CAAc,kBAAkB,KAAK1B,OAAL,CAAa2B,aAA7C;AACA,mBAAK3B,OAAL,CAAa2B,aAAb,GAA6B,CAAC,KAAK3B,OAAL,CAAaQ,KAAb,CAAmBM,EAAnB,CAAsBJ,OAAtB,KAAkC,KAAKV,OAAL,CAAaQ,KAAb,CAAmBC,IAAnB,CAAwBC,OAAxB,EAAnC,IACzBU,KAAKE,OAAL,CAAaG,QAAb,CAAsBb,YAD1B;AAEAR,sBAAQsB,KAAR,CAAc,oBAAoB,KAAK1B,OAAL,CAAa2B,aAA/C;AACD;;AAED,gBAAIP,KAAKG,IAAL,KAAc,iBAAd,IAAmCH,KAAKQ,KAAL,KAAe,cAAtD,EAAsE;AACpE,kBAAI9B,UAAU,KAAKA,OAAnB;AACA,mBAAK+B,kBAAL,GAA0BC,WAAW,YAAY;AAC7C1B,wBAAQ2B,IAAR,CAAa,gCAAgCjC,OAA7C;AACH,eAFyB,EAEvB,KAFuB,CAA1B;AAGD;;AAED,gBAAIsB,KAAKG,IAAL,KAAc,iBAAd,IAAmCH,KAAKQ,KAAL,KAAe,gBAAtD,EAAwE;AACtE,kBAAI,KAAKC,kBAAT,EAA6B;AAC3BG,6BAAa,KAAKH,kBAAlB;AACA,qBAAKA,kBAAL,GAA0B,IAA1B;AACD;AACD,mBAAKI,SAAL;AACA,mBAAKC,WAAL;AACA;AACD;;AAED,gBAAId,KAAKG,IAAL,KAAc,MAAlB,EAA0B;AACxBnB,sBAAQsB,KAAR,CAAcN,IAAd;AACA;AACD;AACD,iBAAKe,UAAL,CAAgBf,IAAhB;AACD;;;qCAEUA,I,EAAM;AACf,iBAAK,IAAIgB,IAAI,CAAb,EAAgBA,IAAIhB,KAAKA,IAAL,CAAUiB,MAA9B,EAAsCD,GAAtC,EAA2C;AACzC,kBAAIE,QAAQlB,KAAKA,IAAL,CAAUgB,CAAV,CAAZ;AACA,kBAAIG,SAAS,KAAKpC,OAAL,CAAamC,MAAME,IAAnB,CAAb;AACA,kBAAI,CAACD,MAAL,EAAa;AACX,oBAAIE,SAAS,KAAKC,iBAAL,CAAuBJ,MAAME,IAA7B,CAAb;AACAD,yBAAS,EAACI,QAAQF,OAAOG,IAAhB,EAAsBC,IAAIJ,OAAOI,EAAjC,EAAqCC,YAAY,EAAjD,EAAT;AACA,qBAAK3C,OAAL,CAAamC,MAAME,IAAnB,IAA2BD,MAA3B;AACD;;AAEDA,qBAAOO,UAAP,CAAkBC,IAAlB,CAAuB,CAACT,MAAMU,KAAP,EAAc5B,KAAK6B,kBAAnB,CAAvB;AACA,kBAAIV,OAAOO,UAAP,CAAkBT,MAAlB,GAA2B,KAAKrC,OAAL,CAAa2B,aAA5C,EAA2D;AACzDY,uBAAOO,UAAP,CAAkBI,KAAlB;AACD;AACF;AACF;;;4CAEiBV,I,EAAM;AACtB,gBAAIW,MAAM,KAAKjD,MAAL,CAAYkD,YAAZ,CAAyBZ,IAAzB,CAAV;AACA,gBAAI,CAACW,GAAL,EAAU;AACR,qBAAOX,IAAP;AACD;;AAED,gBAAIa,aAAa,CAAC,WAAD,EAAc,sBAAd,CAAjB;AACA,gBAAIC,qBAAqB,CAAC,WAAD,EAAc,sBAAd,EAAsC,OAAtC,EAA+C,WAA/C,EAA4D,eAA5D,CAAzB;;AAEA,gBAAIC,SAAS,EAAb;AACA,gBAAIC,SAAS,EAAb;AACA,iBAAK,IAAIC,CAAT,IAAcJ,UAAd,EAA0B;AACxB,kBAAIL,QAAQG,IAAIO,UAAJ,CAAeL,WAAWI,CAAX,CAAf,CAAZ;AACA,kBAAIT,SAAS,CAACA,MAAMW,WAAN,GAAoBC,UAApB,CAA+B,MAA/B,CAAd,EAAsD;AACpDL,uBAAO,QAAP,IAAmB,EAAEM,MAAMb,KAAR,EAAeA,OAAOA,KAAtB,EAAnB;AACAQ,uBAAOT,IAAP,CAAYC,KAAZ;AACD;AACF;;AAED,gBAAIc,MAAM,EAAV;AACA,iBAAK,IAAIC,CAAT,IAAcZ,IAAIO,UAAJ,CAAe,QAAf,CAAd,EAAwC;AACtC,kBAAIM,YAAYb,IAAIO,UAAJ,CAAe,QAAf,EAAyBK,CAAzB,CAAhB;AACA,kBAAIT,mBAAmBW,OAAnB,CAA2BD,SAA3B,MAA0C,CAAC,CAA/C,EAAkD;AAChD,oBAAIhB,QAAQG,IAAIO,UAAJ,CAAeM,SAAf,CAAZ;AACA,oBAAIhB,KAAJ,EAAW;AACTc,sBAAIf,IAAJ,CAASiB,YAAY,GAAZ,GAAkBhB,KAA3B;AACAO,yBAAOS,SAAP,IAAoB,EAAEH,MAAMb,KAAR,EAAeA,OAAOA,KAAtB,EAApB;AACD;AACF;AACF;;AAEDQ,mBAAOT,IAAP,CAAYe,IAAII,IAAJ,CAAS,GAAT,CAAZ;;AAEA,gBAAIC,OAAO,EAAX;AACA,gBAAIC,QAAQ,IAAZ;AACA,gBAAIjB,IAAIO,UAAJ,CAAe,gBAAf,CAAJ,EAAsC;AACpCH,qBAAO,OAAP,IAAkB,EAAEM,MAAMV,IAAIO,UAAJ,CAAe,gBAAf,CAAR,EAA2CV,OAAOG,IAAIO,UAAJ,CAAe,gBAAf,CAAlD,EAAlB;AACAS,sBAAQhB,IAAIO,UAAJ,CAAe,gBAAf,IAAmC,GAA3C;AACAU,sBAAQ,KAAKrE,OAAL,CAAaoD,IAAIO,UAAJ,CAAe,gBAAf,CAAb,CAAR;AACD,aAJD,MAIO;AACLU,sBAAQC,EAAEC,IAAF,CAAO,KAAKvE,OAAZ,EAAqB;AAAA,uBAAK,IAAL;AAAA,eAArB,CAAR;AACD;AACD,gBAAI8C,KAAKsB,OAAOX,OAAOU,IAAP,CAAY,GAAZ,CAAhB;AACA,gBAAItB,OAAOwB,QAAQ,KAAKnE,WAAL,CAAiBsE,OAAjB,CAAyBH,KAAzB,EAAgCb,MAAhC,CAAR,GAAkDV,EAA7D;AACA,mBAAO,EAACA,MAAD,EAAKD,UAAL,EAAP;AACD;;;sCAEW;AACV,gBAAI4B,aAAa,EAAjB;AACA,iBAAK,IAAIhC,IAAT,IAAiB,KAAKrC,OAAtB,EAA+B;AAC7BqE,yBAAWzB,IAAX,CAAgB,KAAK5C,OAAL,CAAaqC,IAAb,CAAhB;AACD;AACDgC,uBAAWC,IAAX,CAAgB,UAACC,CAAD,EAAIC,CAAJ;AAAA,qBAAUD,EAAE7B,EAAF,CAAK+B,aAAL,CAAmBD,EAAE9B,EAArB,CAAV;AAAA,aAAhB;AACA,gBAAItC,QAAQiE,WAAWnC,MAAX,GAAoB,CAApB,GAAwBmC,WAAW,CAAX,EAAc1B,UAAd,CAAyB,CAAzB,EAA4B,CAA5B,CAAxB,GAAyD,CAArE;AACA,gBAAI+B,MAAML,WAAWnC,MAAX,GAAoB,CAApB,GAAwBmC,WAAW,CAAX,EAAc1B,UAAd,CAAyB0B,WAAW,CAAX,EAAc1B,UAAd,CAAyBT,MAAzB,GAAgC,CAAzD,EAA4D,CAA5D,CAAxB,GAAyF,CAAnG;AACA,iBAAKH,WAAL,CAAiB;AACfd,oBAAMoD,UADS;AAEfhE,qBAAO,EAACC,MAAMd,OAAOY,KAAP,CAAP,EAAsBO,IAAInB,OAAOkF,GAAP,CAA1B;AAFQ,aAAjB;AAID;;;kCAEOC,K,EAAO;AACb1E,oBAAQsB,KAAR,CAAc,cAAd,EAA8BoD,KAA9B;AACA,iBAAKvF,OAAL,CAAaG,MAAb,CAAoBoF,KAApB;AACD;;;sCAEW1D,I,EAAM;AAChBhB,oBAAQsB,KAAR,CAAc,sBAAsB,KAAK5B,OAAzC;AACA,iBAAKP,OAAL,CAAaE,OAAb,CAAqB2B,IAArB;AACD;;;iCAEM;AACL,gBAAI,KAAKlB,MAAT,EAAiB;AACbE,sBAAQsB,KAAR,CAAc,kCAAd;AACA,mBAAKxB,MAAL,CAAY6E,KAAZ;AACA,mBAAK7E,MAAL,GAAc,IAAd;AACD;AACJ","file":"stream_handler.js","sourcesContent":["// Copyright (C) 2019 SignalFx, Inc. All rights reserved.\nimport moment from 'moment';\n\nfunction defer() {\n  var res, rej;\n\n  var promise = new Promise((resolve, reject) => {\n    res = resolve;\n    rej = reject;\n  });\n\n  promise.resolve = res;\n  promise.reject = rej;\n\n  return promise;\n}\n\nexport class StreamHandler {\n\n  constructor(signalflow, program, aliases, options, templateSrv) {\n    this.signalflow = signalflow;\n    this.program = program;\n    this.aliases = aliases;\n    this.options = options;\n    this.templateSrv = templateSrv;\n    this.handle = null;\n    this.promise = defer();\n  }\n\n  start() {\n    this.metrics = {};\n    console.log('Starting SignalFlow computation: ' + this.program);\n    this.handle = this.signalflow.execute({\n      program: this.program,\n      start: this.options.range.from.valueOf(),\n      resolution: this.options.resolutionMs,\n      stop: this.options.range.to.valueOf(),\n      immediate: true,\n    });\n    this.handle.stream(this.handleData.bind(this));\n    return this.promise;\n  }\n\n\n  handleData(err, data) {\n\n    if (err) {\n      this.onError(err.message);\n      return;\n    }\n\n    if (data.type === 'message' && data.message.messageCode === 'JOB_RUNNING_RESOLUTION') {\n      this.options.resolutionMs = data.message.contents.resolutionMs;\n      console.debug('Original MDP:' + this.options.maxDataPoints);\n      this.options.maxDataPoints = (this.options.range.to.valueOf() - this.options.range.from.valueOf())\n        / data.message.contents.resolutionMs;\n      console.debug('Calculated MDP:' + this.options.maxDataPoints);\n    }\n\n    if (data.type === 'control-message' && data.event === 'STREAM_START') {\n      var program = this.program;\n      this.streamStartTimeout = setTimeout(function () {\n          console.warn('Long running job detected: ' + program);\n      }, 15000);\n    }\n\n    if (data.type === 'control-message' && data.event === 'END_OF_CHANNEL') {\n      if (this.streamStartTimeout) {\n        clearTimeout(this.streamStartTimeout);\n        this.streamStartTimeout = null;\n      }\n      this.flushData();\n      this.onCompleted();\n      return;\n    }\n\n    if (data.type !== 'data') {\n      console.debug(data);\n      return;\n    }\n    this.appendData(data);\n  }\n\n  appendData(data) {\n    for (var i = 0; i < data.data.length; i++) {\n      var point = data.data[i];\n      var series = this.metrics[point.tsId];\n      if (!series) {\n        var tsName = this.getTimeSeriesName(point.tsId);\n        series = {target: tsName.name, id: tsName.id, datapoints: []};\n        this.metrics[point.tsId] = series;\n      }\n\n      series.datapoints.push([point.value, data.logicalTimestampMs]);\n      if (series.datapoints.length > this.options.maxDataPoints) {\n        series.datapoints.shift();\n      }\n    }  \n  }\n\n  getTimeSeriesName(tsId) {\n    var obj = this.handle.get_metadata(tsId);\n    if (!obj) {\n      return tsId;\n    }\n\n    var candidates = ['sf_metric', 'sf_originatingMetric'];\n    var excludedDimensions = ['sf_metric', 'sf_originatingMetric', 'jobId', 'programId', 'computationId'];\n\n    var tsVars = {};\n    var result = [];\n    for (var c in candidates) {\n      var value = obj.properties[candidates[c]];\n      if (value && !value.toLowerCase().startsWith('_sf_')) {\n        tsVars['metric'] = { text: value, value: value };\n        result.push(value);\n      }\n    }\n\n    var key = [];\n    for (var k in obj.properties['sf_key']) {\n      var dimension = obj.properties['sf_key'][k];\n      if (excludedDimensions.indexOf(dimension) === -1) {\n        var value = obj.properties[dimension];\n        if (value) {\n          key.push(dimension + '=' + value);\n          tsVars[dimension] = { text: value, value: value };\n        }\n      }\n    }\n\n    result.push(key.join(','));\n\n    var repr = '';\n    var alias = null;\n    if (obj.properties['sf_streamLabel']) {\n      tsVars['label'] = { text: obj.properties['sf_streamLabel'] , value: obj.properties['sf_streamLabel']};\n      repr += obj.properties['sf_streamLabel'] + ':';\n      alias = this.aliases[obj.properties['sf_streamLabel']];\n    } else {\n      alias = _.find(this.aliases, a => true);\n    }\n    var id = repr + result.join('/');\n    var name = alias ? this.templateSrv.replace(alias, tsVars) : id; \n    return {id, name};\n  }\n\n  flushData() {\n    var seriesList = [];\n    for (var tsId in this.metrics) {\n      seriesList.push(this.metrics[tsId]);\n    }\n    seriesList.sort((a, b) => a.id.localeCompare(b.id));\n    var start = seriesList.length > 0 ? seriesList[0].datapoints[0][1] : 0;\n    var end = seriesList.length > 0 ? seriesList[0].datapoints[seriesList[0].datapoints.length-1][1] : 0;\n    this.onCompleted({\n      data: seriesList,\n      range: {from: moment(start), to: moment(end)},\n    });\n  }\n\n  onError(error) {\n    console.debug('Stream error', error);\n    this.promise.reject(error);\n  }\n\n  onCompleted(data) {\n    console.debug('Stream completed ' + this.program);\n    this.promise.resolve(data);\n  }\n\n  stop() {\n    if (this.handle) {\n        console.debug('Stopping SignalFlow computation.');\n        this.handle.close();\n        this.handle = null;\n      }\n  }\n\n}\n"]}