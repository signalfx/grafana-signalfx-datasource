{"version":3,"sources":["../src/stream_handler.js"],"names":["defer","res","rej","promise","Promise","resolve","reject","_","moment","MAX_DATAPOINTS_TO_KEEP_BEFORE_TIMERANGE","StreamHandler","signalflow","templateSrv","program","aliases","options","isJobReusable","initializeTimeRange","flushData","stop","execute","handle","intervalMs","stopTimeRaw","startTimeRaw","rangeRaw","from","valueOf","startTime","range","stopTime","to","console","debug","close","log","initialize","params","start","resolution","unbounded","stream","handleData","bind","jobStartTimeout","clearTimeout","setTimeout","metrics","maxDataPoints","resolutionMs","maxDelay","unboundedBatchPhase","relativeStart","returnedDataPoints","err","data","message","type","messageCode","contents","maxDelayMs","event","appendData","batchPhaseFlushTimeout","period","slidingWindowStart","logicalTimestampMs","i","length","point","datapoints","tsId","shift","push","value","nextAdjustedTime","seriesList","minTime","maxTime","timeRangeStart","tsName","getTimeSeriesName","target","name","id","slice","sort","a","b","localeCompare","obj","get_metadata","candidates","excludedDimensions","tsVars","result","c","properties","toLowerCase","startsWith","text","key","k","dimension","indexOf","join","repr","alias","find","replace"],"mappings":"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","file":"stream_handler.js","sourcesContent":["// Copyright (C) 2019 SignalFx, Inc. All rights reserved.\nimport _ from \"lodash\";\nimport moment from 'moment';\n\nfunction defer() {\n  var res, rej;\n\n  var promise = new Promise((resolve, reject) => {\n    res = resolve;\n    rej = reject;\n  });\n\n  promise.resolve = res;\n  promise.reject = rej;\n\n  return promise;\n}\n\nconst MAX_DATAPOINTS_TO_KEEP_BEFORE_TIMERANGE = 1;\n\nexport class StreamHandler {\n\n  constructor(signalflow, templateSrv) {\n    this.signalflow = signalflow;\n    this.templateSrv = templateSrv;\n  }\n\n  start(program, aliases, options) {\n    this.promise = defer();\n    if (this.isJobReusable(program, options)) {\n      this.initializeTimeRange(options);\n      this.flushData();\n    } else {\n      this.stop();\n      this.execute(program, aliases, options);\n    }\n    return this.promise;\n  }\n\n  isJobReusable(program, options) {\n    return this.handle\n      && this.program == program\n      && this.intervalMs == options.intervalMs\n      && ((this.stopTimeRaw == 'now' && this.startTimeRaw == options.rangeRaw.from.valueOf())\n        || (this.startTime == options.range.from.valueOf() && this.stopTime == options.range.to.valueOf()));\n  }\n\n  stop() {\n    if (this.handle) {\n        console.debug('Stopping SignalFlow computation.');\n        this.handle.close();\n        this.handle = null;\n      }\n  }\n\n  execute(program, aliases, options) {\n    console.log('Starting SignalFlow computation: ' + program);\n    this.initialize(program, aliases, options);\n    var params = {\n      program: this.program,\n      start: this.startTime,\n      resolution: this.intervalMs,\n    };\n    if (!this.unbounded) {\n      params['stop'] = this.stopTime;\n      params['immediate'] = true;\n    }\n    this.handle = this.signalflow.execute(params);\n    this.handle.stream(this.handleData.bind(this));\n    if (this.jobStartTimeout) {\n      clearTimeout(this.jobStartTimeout);\n    }\n    this.jobStartTimeout = setTimeout(function () {\n      console.debug('Job inactive for 6 minutes: ' + program);\n      this.stop();\n    }, 360000);\n  }\n\n  initialize(program, aliases, options) {\n    this.metrics = {};\n    this.program = program;\n    this.aliases = aliases;\n    this.initializeTimeRange(options);\n    this.intervalMs = options.intervalMs;\n    this.maxDataPoints = options.maxDataPoints;\n    this.resolutionMs = options.intervalMs;\n    this.maxDelay = 0;\n    this.unbounded = options.rangeRaw.to == 'now';\n    this.unboundedBatchPhase = this.unbounded;\n    this.relativeStart = this.startTimeRaw != this.startTime;\n    this.returnedDataPoints = 0;\n  }\n\n  initializeTimeRange(options) {\n    this.startTime = options.range.from.valueOf();\n    this.stopTime = options.range.to.valueOf();\n    this.startTimeRaw = options.rangeRaw.from.valueOf();\n    this.stopTimeRaw = options.rangeRaw.to.valueOf();\n  }\n\n  handleData(err, data) {\n    if (err) {\n      console.debug('Stream error', err);\n      this.stop();\n      this.promise.reject(err.message);\n      return;\n    }\n\n    if (data.type === 'message' && data.message.messageCode === 'JOB_RUNNING_RESOLUTION') {\n      this.resolutionMs = data.message.contents.resolutionMs;\n    }\n\n    if (data.type === 'message' && data.message.messageCode === 'JOB_INITIAL_MAX_DELAY') {\n      this.maxDelay = data.message.contents.maxDelayMs;\n    }\n    \n    if (data.type === 'control-message' && data.event === 'END_OF_CHANNEL') {\n      this.flushData();\n    }\n\n    if (data.type !== 'data') {\n      console.debug(data);\n      return;\n    }\n\n    if (this.appendData(data) && this.unboundedBatchPhase) {\n      if (this.batchPhaseFlushTimeout) {\n        clearTimeout(this.batchPhaseFlushTimeout);\n      }\n      this.batchPhaseFlushTimeout = setTimeout(() => this.flushData(), 1000);\n    }\n  }\n\n  appendData(data) {\n    var period = (this.stopTime - this.startTime);\n    var slidingWindowStart = data.logicalTimestampMs - period - MAX_DATAPOINTS_TO_KEEP_BEFORE_TIMERANGE * this.resolutionMs;\n    for (var i = 0; i < data.data.length; i++) {\n      var point = data.data[i];\n      var datapoints = this.metrics[point.tsId];\n      if (!datapoints) {\n        datapoints = [];\n        this.metrics[point.tsId] = datapoints;\n      }\n      while (datapoints.length > 0 && (this.relativeStart && slidingWindowStart > datapoints[0][1])) {\n        datapoints.shift();\n      }\n      datapoints.push([point.value, data.logicalTimestampMs]);\n    }\n    var nextAdjustedTime = data.logicalTimestampMs + this.maxDelay + this.resolutionMs;\n    return nextAdjustedTime > this.stopTime;\n  }\n\n  flushData() {\n    this.unboundedBatchPhase = false;\n    var seriesList = [];\n    var minTime = 0;\n    var maxTime = 0;\n    var timeRangeStart = this.startTime - MAX_DATAPOINTS_TO_KEEP_BEFORE_TIMERANGE * this.resolutionMs;\n    for (var tsId in this.metrics) {\n      var datapoints = this.metrics[tsId];\n      while (datapoints.length > 0 && timeRangeStart > datapoints[0][1]) {\n        datapoints.shift();\n      }\n      if (datapoints.length > 0) {\n        if (minTime == 0 || minTime > datapoints[0][1]) {\n          minTime = datapoints[0][1];\n        }\n        if (maxTime == 0 || maxTime < datapoints[datapoints.length-1][1]) {\n          maxTime = datapoints[datapoints.length-1][1];\n        }\n      }\n      var tsName = this.getTimeSeriesName(tsId);\n      seriesList.push({ target: tsName.name, id: tsName.id, datapoints: datapoints.slice() });\n    }\n    // Ensure consistent TS order\n    seriesList.sort((a, b) => a.id.localeCompare(b.id));\n    var data = {\n      data: seriesList,\n      range: {from: moment(minTime), to: moment(maxTime)},\n    };\n    this.promise.resolve(data);\n    console.debug('Data returned: ' + this.program);\n  }\n\n  getTimeSeriesName(tsId) {\n    var obj = this.handle.get_metadata(tsId);\n    if (!obj) {\n      return tsId;\n    }\n\n    var candidates = ['sf_metric', 'sf_originatingMetric'];\n    var excludedDimensions = ['sf_metric', 'sf_originatingMetric', 'jobId', 'programId', 'computationId'];\n\n    var tsVars = {};\n    var result = [];\n    for (var c in candidates) {\n      var value = obj.properties[candidates[c]];\n      if (value && !value.toLowerCase().startsWith('_sf_')) {\n        tsVars['metric'] = { text: value, value: value };\n        result.push(value);\n      }\n    }\n\n    var key = [];\n    for (var k in obj.properties['sf_key']) {\n      var dimension = obj.properties['sf_key'][k];\n      if (excludedDimensions.indexOf(dimension) === -1) {\n        var value = obj.properties[dimension];\n        if (value) {\n          key.push(dimension + '=' + value);\n          tsVars[dimension] = { text: value, value: value };\n        }\n      }\n    }\n\n    result.push(key.join(','));\n\n    var repr = '';\n    var alias = null;\n    if (obj.properties['sf_streamLabel']) {\n      tsVars['label'] = { text: obj.properties['sf_streamLabel'] , value: obj.properties['sf_streamLabel']};\n      repr += obj.properties['sf_streamLabel'] + ':';\n      alias = this.aliases[obj.properties['sf_streamLabel']];\n    } else {\n      alias = _.find(this.aliases, a => true);\n    }\n    var id = repr + result.join('/');\n    var name = alias ? this.templateSrv.replace(alias, tsVars) : id; \n    return {id, name};\n  }\n}\n"]}